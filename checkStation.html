<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>수요조사 결과</title>
    <style>
      html, body{
        height: 100%;
        margin: 0px;
        padding: 0px
      }
      #map-canvas{
        width: 100%;
        height: 100%;
      }
    </style>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script src="http://joohyuck.github.io/parse-1.4.2.min.js"></script> 
    <script src="http://joohyuck.github.io/FileSaver.min.js"></script>
    <script type="text/javascript">
      var map;
      var markers = [];
      google.maps.event.addDomListener(window, 'load', initialize);

      Parse.initialize("eRm640kNvozWNgmmnqAneyJLbXPWh5KwhKSkzn1B", "pPHnbrqZL4EpRwjW1mXh8S2JBzEO93coQwuTjGib");

      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(37.550965, 126.925331),
          zoom: 13
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        google.maps.event.addListener(map, 'dragend', function() {
          markers.forEach(function(element){
            element.setMap(null);
          });
          markers = [];


          var query = new Parse.Query("Station");

          var northEast = map.getBounds().getNorthEast();
          var southWest = map.getBounds().getSouthWest();
          var southwestOfSF = new Parse.GeoPoint(southWest.lat(), southWest.lng());
          var northeastOfSF = new Parse.GeoPoint(northEast.lat(), northEast.lng());

          query.withinGeoBox("location", southwestOfSF, northeastOfSF);
          query.equalTo('surveyPoint', true);
          query.limit(1000);
          query.find({
            success: function(placesObjects) {
              placesObjects.forEach(function(element){
                var marker = new google.maps.Marker({
                    position : new google.maps.LatLng(element.attributes.location.latitude, element.attributes.location.longitude),
                    icon : "http://joohyuck.github.io/image/busStation_icon_red_big.png",
                    map : map
                });
                var contentString = '<div>';
                contentString +='<h4>'+element.attributes.stationName+'</h4>';
                contentString += '</div>';
                var infowindow = new google.maps.InfoWindow({
                    content: contentString
                });

                google.maps.event.addListener(marker, 'mouseover', function() {
                  infowindow.open(map,marker);
                });
                google.maps.event.addListener(marker, 'mouseout', function() {
                  infowindow.close();
                });
                /*
                google.maps.event.addListener(marker, 'click', function() {
                  marker.setVisible(false);
                  element.destroy({
                    success: function(myObject) {
                      console.log(myObject.attributes.name +" 삭제");
                      // The object was deleted from the Parse Cloud.
                    },
                    error: function(myObject, error) {
                      // The delete failed.
                      // error is a Parse.Error with an error code and message.
                    }
                  });
                });
                */
                markers.push(marker);
              });
            }
          });

        });
      }

/*
    var stationArray = [];
      $.get("http://joohyuck.github.io/file/pre_stations.csv",function(data){
        var lines = data.split("\n");
        console.log(lines.length+"개의 정류장");
        lines.forEach(function(element, index){
          var arr = element.split(",");
          stationArray.push(arr);
        });
      });

      var map;
      google.maps.event.addDomListener(window, 'load', initialize);

      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(37.550965, 126.925331),
          zoom: 13
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        //지도 이동할 때마다 이벤트 실행
        google.maps.event.addListener(map, 'dragend', function() {
          console.log("event fired!")
          var northEast = map.getBounds().getNorthEast();
          var southWest = map.getBounds().getSouthWest();

          var selectedStationArray = [];
          stationArray.forEach(function(element){
            var a = element[3] - northEast.lat();
            var b = element[3] - southWest.lat();
            var c = element[4] - northEast.lng();
            var d = element[4] - southWest.lng();
            if( a*b < 0 && c*d < 0) selectedStationArray.push(element);
          });
          selectedStationArray.forEach(function(element){
            var passRouteArray = element[7].split("&");
            var passRedRoute = 0;
            passRouteArray.forEach(function(el){
              if(el.split("")[0] == "*") passRedRoute ++;
            });

            if(passRedRoute == 0) return;

            var contentString = '<div>';
            contentString +='<h4>'+element[1]+'</h4>';
            passRouteArray.forEach(function(el){
              contentString +='<p>'+el+'</p>';
            })
            contentString += '</div>';

            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });

            var img;
            if(passRedRoute < 2 ){
              img = "http://joohyuck.github.io/image/busStation_icon_big.png";
            }
            else{
              img = "http://joohyuck.github.io/image/busStation_icon_red_big.png";
            }

            var marker = new google.maps.Marker({
                position : new google.maps.LatLng(element[3], element[4]),
                icon : img,
                map : map
            });

            google.maps.event.addListener(marker, 'mouseover', function() {
              infowindow.open(map,marker);
            });
            google.maps.event.addListener(marker, 'mouseout', function() {
              infowindow.close();
            });
          });

          subwayStationArray.forEach(function(element){
            if( notIncludedStation.indexOf(element.split(" ")[0]) != -1) {
            var marker = new google.maps.Marker({
                position : new google.maps.LatLng(element.split(" ")[1], element.split(" ")[2]),
                map : map
            });
            }
          });

        });
      }
*/

    </script>
  </head>
  <body>
    <section id="map-canvas"></section>
  </body>
</html>
